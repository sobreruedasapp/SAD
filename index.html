<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#003366" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SAD Tickets" />
  <meta name="display" content="standalone" />
  <link rel="manifest" href="manifest.json?v=2">
  <link rel="icon" href="sr-icon-192-v2.png">
  <link rel="apple-touch-icon" href="sr-icon-192-v2.png">
  <meta name="theme-color" content="#003366">
  <title>SAD Tickets</title>

  <style>
    :root {
      --bg1: #003366;
      --bg2: #0077cc;
      --card-bg: rgba(255,255,255,0.12);
      --text-main: #ffffff;
      --text-dark: #003366;
      --radius-card: 24px;
      --radius-field: 12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", "Roboto", "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; font-family: var(--font); }
    body {
      margin: 0; min-height: 100vh;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      color: var(--text-main);
      display: flex; justify-content: center; align-items: flex-start;
      padding: 24px 16px 48px;
    }
    .card {
      width: 100%; max-width: 420px;
      background: var(--card-bg);
      border-radius: var(--radius-card);
      box-shadow: 0 16px 32px rgba(0,0,0,0.4);
      padding: 20px 16px 24px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .header { text-align: center; margin-bottom: 16px; }
    .logo { width: 100px; margin: 0 auto 10px auto; display: block; object-fit: contain; }
    h1 { font-size: 1.1rem; font-weight: 600; margin: 0; color: var(--text-main); }
    form { display: flex; flex-direction: column; gap: 12px; }
    label { font-size: .9rem; font-weight: 500; color: var(--text-main); margin-bottom: 4px; display: block; }
    .control {
      width: 100%; border: none; border-radius: var(--radius-field);
      background: #fff; color: var(--text-dark);
      font-size: 1rem; font-weight: 500; padding: 14px 12px;
    }
    .row-2 { display: flex; gap: 12px; }
    .row-2 .group { flex: 1; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .row-3 .group label { font-size: 0.85rem; text-align: center; display: block; }
    .row-3 .control { text-align: center; font-size: 1rem; padding: 12px 8px; }
    button {
      width: 100%; border: none; border-radius: var(--radius-field);
      background: #fff; color: var(--text-dark);
      font-size: 1rem; font-weight: 600;
      padding: 16px 14px; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    #msg { text-align: center; min-height: 1.4em; font-size: .95rem; font-weight: 600; margin-top: 6px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @supports (-webkit-touch-callout:none) { input, select, button { font-size:16px !important; } }
  </style>
  <script>
(function () {
  const ORIGINAL_FETCH = window.fetch;
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwTwp6Cc35zWr18MeSc9hkE18m0j_Km6S9mOv5kY-2AFrHnFivLLiplQTyQRL9ysg7R/exec";
  const PROXY = "https://sad-proxy.colatino-ventas-enlinea.workers.dev/";

  // ‚úÖ Hacerlo accesible globalmente
  window.BACKEND_URL = BACKEND_URL;

  // ‚úÖ Interceptar fetch sin errores
  window.fetch = function (input, init = {}) {
    try {
      const url =
        typeof input === "string"
          ? input
          : (input && input.url) ? input.url : "";

      // Solo redirigimos si apunta al Apps Script
      if (url && url === BACKEND_URL) {
        const proxyURL = PROXY + "?url=" + encodeURIComponent(BACKEND_URL);
        return ORIGINAL_FETCH(proxyURL, init);
      }

      // Caso normal: llamada externa (no interceptada)
      return ORIGINAL_FETCH(input, init);
    } catch (err) {
      console.error("‚ö†Ô∏è Error interceptando fetch:", err);
      return ORIGINAL_FETCH(input, init);
    }
  };
})();
</script>
</head>

<body>

  <!-- SPINNER DE CARGA -->
  <div id="spinner" style="position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.6); z-index:1000; visibility:hidden;">
    <div style="width:60px; height:60px; border:6px solid #fff; border-top-color:#0077cc; border-radius:50%; animation:spin 1s linear infinite;"></div>
  </div>

  <!-- FORMULARIO PRINCIPAL -->
  <div class="card">
    <div class="header">
      <img class="logo" src="sr-logo-blanco-192.png" alt="SR Logo" onerror="this.style.display='none'">
      <h1>SAD Ticket Upload v2.4</h1>
    </div>

    <form id="ticketForm">
      <label>Fecha</label>
      <input class="control" type="date" name="fecha" id="fecha" required>

      <label>Tienda</label>
      <select class="control" id="tienda" name="tienda" required></select>

      <label>Repartidor</label>
      <select class="control" id="repartidor" name="repartidor" required></select>

      <label>Franja horaria</label>
      <select class="control" id="franja" name="franja" required></select>

      <div class="row-2">
        <div class="group">
          <label>Pedidos (P)</label>
          <input class="control" type="number" name="pedidos" min="-40" max="40" value="" required>
        </div>
        <div class="group">
          <label>Dobles (D)</label>
          <input class="control" type="number" name="dobles" min="-16" max="16" value="0" required>
        </div>
      </div>

      <div class="row-3">
        <div class="group">
          <label>XR</label>
          <input class="control" type="number" name="xr" min="-12" max="12" value="0" required>
        </div>
        <div class="group">
          <label>Km</label>
          <input class="control" type="number" name="km" id="km" min="-200" max="200" value="0" required>
        </div>
        <div class="group">
          <label>Obs</label>
          <input class="control" type="text" name="obs" id="obs" maxlength="20" placeholder="Opcional">
        </div>
      </div>

        <label>Foto del ticket</label>
  <div style="display:flex; gap:10px;">
    <button type="button" id="btnCamara" style="flex:1;">üì∑ Sacar foto</button>
    <button type="button" id="btnArchivo" style="flex:1;">üñºÔ∏è Subir archivo</button>
  </div>
  <input class="control" type="file" id="foto" accept="image/*" style="display:none;" required>

      <button type="submit">‚¨ÜÔ∏è Subir ticket</button>
      <div id="msg"></div>
    </form>
  </div>

  <script>
    const msg = document.getElementById("msg");
    const spinner = document.getElementById("spinner");

    // Fecha por defecto
    document.getElementById("fecha").value = new Date().toISOString().split("T")[0];

    // Cargar listas desde Apps Script
    fetch(window.BACKEND_URL)
      .then(r => r.json())
      .then(data => {
        fillSelect("tienda", data.tiendas);
        fillSelect("repartidor", data.repartidores);
        fillSelect("franja", data.franjas);
      })
      .catch(err => msg.textContent = "‚ö†Ô∏è Error cargando listas: " + err.message);

function fillSelect(id, arr) {
  const el = document.getElementById(id);
  el.innerHTML = "";

  // Agrega la opci√≥n inicial
  const placeholder = document.createElement("option");
  if (id === "tienda") placeholder.textContent = "Seleccione tienda...";
  else if (id === "repartidor") placeholder.textContent = "Seleccione repartidor...";
  else if (id === "franja") placeholder.textContent = "Seleccione franja horaria...";
  placeholder.value = "";
  placeholder.disabled = true;
  placeholder.selected = true;
  el.appendChild(placeholder);

  // Agrega el resto de las opciones
  arr.forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    el.appendChild(op);
  });
}
    // === Control de botones para foto ===
    const fotoInput = document.getElementById("foto");
    document.getElementById("btnCamara").addEventListener("click", () => {
      fotoInput.removeAttribute("capture"); // limpia cualquier modo anterior
      fotoInput.setAttribute("capture", "environment"); // fuerza c√°mara
      fotoInput.click();
    });
    document.getElementById("btnArchivo").addEventListener("click", () => {
      fotoInput.removeAttribute("capture"); // elimina c√°mara, abre galer√≠a
      fotoInput.click();
    });
    // Subir ticket con OCR y feedback visual
    document.getElementById("ticketForm").addEventListener("submit", e => {
      e.preventDefault();
      const file = document.getElementById("foto").files[0];
      if (!file) return alert("Por favor, selecciona una foto del ticket.");
      spinner.style.visibility = "visible";
      msg.textContent = "‚è≥ Subiendo ticket...";
const reader = new FileReader();
reader.onload = async () => {
  const datos = Object.fromEntries(new FormData(document.getElementById("ticketForm")).entries());
  datos.imagenBase64 = reader.result;

  try {
    const resp = await fetch(window.BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(datos)
    });

    const text = await resp.text();

    if (text.includes("OK")) {
      // mostrar el mensaje completo del servidor
      msg.innerHTML = `‚úÖ ${text}`;
      msg.style.color = "#9dffb0";
    } else if (text.includes("NO_DETECTADO")) {
      msg.innerHTML = "‚ö†Ô∏è Ticket subido.";
      msg.style.color = "#ffcc00";
    } else {
      msg.textContent = text;
      msg.style.color = text.includes("ERROR") ? "#ffdddd" : "#9dffb0";
    }

  } catch (err) {
    msg.textContent = "‚ùå Error: " + err.message;
    msg.style.color = "#ffdddd";
  } finally {
  spinner.style.visibility = "hidden";

  // Mantener mensaje visible unos segundos antes de limpiar
  setTimeout(() => {
    const form = document.getElementById("ticketForm");
    form.reset();

    // Restablecer selects a su estado original
    document.getElementById("tienda").selectedIndex = 0;
    document.getElementById("repartidor").selectedIndex = 0;
    document.getElementById("franja").selectedIndex = 0;

    // Volver a poner la fecha actual
    document.getElementById("fecha").value = new Date().toISOString().split("T")[0];

    // Limpiar el mensaje visualmente despu√©s de 3 segundos
    msg.style.transition = "opacity 0.5s ease";
    msg.style.opacity = "0";
    setTimeout(() => { msg.textContent = ""; }, 600);
  }, 5000); // mensaje visible durante 3 segundos
}
};

reader.readAsDataURL(file);
});
   </script>
</body>
</html>
